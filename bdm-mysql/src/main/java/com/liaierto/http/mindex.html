<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>DataTables</title>
  <meta name="description" content="这是一个 table 页面">
  <meta name="keywords" content="table">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="icon" type="image/png" href="assets/i/1.png">
  <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
  <link href="//cdn.bootcss.com/datatables/1.10.9/css/dataTables.bootstrap.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/amazeui.min.css"/>
  <link rel="stylesheet" href="assets/css/admin.css">
  <link href="jd/css/plugins/jqgrid/ui.jqgrid.css" rel="stylesheet">
  <link href="jd/css/style.css?v=2.2.0" rel="stylesheet">
    
  <script src="//cdn.bootcss.com/datatables/1.10.9/js/jquery.js"></script>
  <script type="text/javascript" src="assets/json/jquery.json-2.2.js"></script>
  <script type="text/javascript" src="assets/json/jsonpath-0.8.0.js"></script> 
  <script src="jd/js/plugins/jqgrid/i18n/grid.locale-cn.js"></script>
  <script src="jd/js/plugins/jqgrid/jquery.jqGrid.min.js"></script>
  <script src="assets/js/amazeui.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  var lastsel2=null;
  var savedRow = null;  
	var savedCol = null; 
	 var name = null;
  $(document).ready(function() {
	  var pager_selector = "#Pager";
      var o_data = null;
      var currentPage = 1;
      var objIns = new Object();
      objIns.currentpage =currentPage;
	    objIns.pageRow     =10;
 	    objIns.object     ="ttsx";
     jQuery("#rowed5").jqGrid({
          url: 'BaseAction',
      	datatype: "json",
          postData: {"service": "objectMetaService","method": "queryPage", "parameter":$.toJSON(objIns)},
			height: 400,
          height : 250,
          colNames : [ 'm_id','属性名称', '属性描述', '类型', '长度','主键' ],
          colModel : [ 
              {name : 'm_id',index : 'm_id',width : 190,sorttype : "string",hidden:true,editable : false},
              {name : 'name',index : 'name',width : 190,sorttype : "string",editable : true},
              {name : 'description',index : 'description',width : 190,sorttype : "string",editable : true},
              {name : 'type',index : 'type',width : 190,editable:true,edittype:'select',editoptions: {value: 'string:string;int:int;blob:blob'}},
              {name : 'len', index : 'len', width : 190,sorttype : "string",editable : true},
              {name : 'iskey', index : 'iskey', width : 190,sorttype : "string",editable : true,formatter: "checkbox",formatoptions:{disabled:false}}
          ],
          jsonReader: {
              root: "rows",
              page: "page",
              total: "total",
              records: "records",
              repeatitems: false
          },
          pager: "#Pager",
          rowNum: '10', //每页显示记录数
          multiselect: false, //是否支持多选   
          sortorder: "desc",
          closeAfterAdd: true, //保存后关闭窗体
          recordtext: "记录 {0} - {1} 总记录数 {2}",//显示记录数的格式
          emptyrecords: "无数据",//空记录时的提示信息
          loadtext: "获取数据中...",//获得数据时的提示信息
          pgtext: "第 {0}页 总页数 {1}",//页数显示格式
          altRows: true,//隔行变色
          altclass: 'ui-widget-content-altclass',//隔行变色样式
          cellEdit: true,
          cellsubmit: 'clientArray',
          gridComplete: function(){
          	
          },
          onSelectRow : function(id) {
              if (id && id !== lastsel2) {
                  jQuery("#rowed5").saveRow(lastsel2, false, 'clientArray');
                  //jQuery('#rowed5').jqGrid('restoreRow', lastsel2);
                  //jQuery('#rowed5').jqGrid('editRow', id, true);
                  lastsel2 = id;
              }
          },
          onCellSelect: function(rowid, iCol, cellcontent){// 进入编辑框显示 rowid 唯一;iRow行号
         	    savedRow = rowid;  
              savedCol = iCol; 
         },
         onPaging: function(pgButton){//分页事件  
          	
	            if(pgButton=="next_Pager"){
	            	currentPage = currentPage+1;
	            }
	            if(pgButton=="prev_Pager"){
	            	currentPage = currentPage-1;
	            }
	            if(pgButton=="last_Pager"){

	            	currentPage =$("#rowed5").getGridParam ('lastpage');
	            }
	            if(pgButton=="first_Pager"){
	            	currentPage=1;
	            }
	                objIns.currentpage =currentPage;
	                $("#rowed5").setGridParam ({ postData: {"service": "objectMetaService","method": "queryPage", "parameter":$.toJSON(objIns) }}).trigger('reloadGrid');
	            },
			autowidth: true
      });
  });

  function tableManage(){
	  var my = document.getElementById("admin-offcanvas");
	    if (my != null)
	        my.parentNode.removeChild(my);
  }
  // 新增
  function add(){
      jQuery("#rowed5").saveRow(lastsel2, false, 'clientArray');
      var id = jQuery("#rowed5").jqGrid("getRowData").length;
      var data = {
              name: "name", 
              description: "desc", 
              type: "int",
              length : ""
          };
      jQuery("#rowed5").jqGrid('addRowData', id+1, data); 
  }

  // 保存
  function save(){
	  $('#my-prompt').modal({
	      relatedTarget: this,
	      onConfirm: function(e) {
	    	  savetable();
	      },
	      onCancel: function(e) {
	      }
	    });
  	
  }
  
  //保存表的列属性
  function savemeta(){
	  $("#rowed5").jqGrid('saveCell', savedRow, savedCol);  
      jQuery("#rowed5").saveRow(lastsel2, false, 'clientArray');
      var allData = jQuery("#rowed5").jqGrid("getRowData");
      var obj = new Object();
      obj.rows= allData;
      obj.object = name;
      $.ajax({
	          type : "post",
	          url: "BaseAction",
	          data: {
	                "service": "objectMetaService",
	                "method": "update",
	                "parameter": $.toJSON(obj),
	                },
	          dataType:"text",
	          success: function(data) {
	             var pResult = JSON.parse(data);
	             console.info(pResult.code);
	             if(pResult.code==1){
	                alert("保存成功");
	                $("#doc-ipt-3").val("");
	                $("#doc-ipt-2").val("");
	                
	             }else{
	                alert("保存失败");
	             }
	                        
	          }
	    });
  }

  // 保存
  function savetable(){
      var obj = new Object();
      name = $("#doc-ipt-3").val();
      obj.name=name;
      obj.description=$("#doc-ipt-2").val();
      $.ajax({
	          type : "post",
	          url: "BaseAction",
	          data: {
	                "service": "objectService",
	                "method": "add",
	                "parameter": $.toJSON(obj)
	                },
	          dataType:"text",
	          success: function(data) {
	             var pResult = JSON.parse(data);
	             console.info(pResult.code);
	             if(pResult.code==1){
	            	 savemeta();
	             }else{
	                alert("保存失败");
	             }
	                        
	          }
	    });
  }
  
  </script>
</head>
<body>
<!--[if lte IE 9]>
<p class="browsehappy">你正在使用<strong>过时</strong>的浏览器，Amaze UI 暂不支持。 请 <a href="http://browsehappy.com/" target="_blank">升级浏览器</a>
  以获得更好的体验！</p>
<![endif]-->

<header class="am-topbar admin-header">
  <div class="am-topbar-brand">
    <strong>DataTable</strong> <small>WEB,安卓通过各种API直接操作数据表</small>
  </div>

  <div class="am-collapse am-topbar-collapse" id="topbar-collapse">

    <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list">
      <li class="am-dropdown" data-am-dropdown>
        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
          <span class="am-icon-users"></span> 管理员 <span class="am-icon-caret-down"></span>
        </a>
        <ul class="am-dropdown-content">
          <li><a href="#"><span class="am-icon-power-off"></span> 退出</a></li>
        </ul>
      </li>
      <li class="am-hide-sm-only"><a href="javascript:;" id="admin-fullscreen"><span class="am-icon-arrows-alt"></span> <span class="admin-fullText">开启全屏</span></a></li>
    </ul>
  </div>
</header>

<div class="am-cf admin-main">
  <!-- sidebar start -->
  <div class="admin-sidebar am-offcanvas" id="admin-offcanvas">
    <div class="am-offcanvas-bar admin-offcanvas-bar">
      <ul class="am-list admin-sidebar-list">
        <li><a href="admin-index.html"><span class="am-icon-home"></span> 首页</a></li>
        <li><a href="table.html"  ><span class="am-icon-table"></span> 表管理</a></li>
        <li><a href="method.html"><span class="am-icon-pencil-square-o"></span> 通用方法管理</a></li>
        <li><a href="#"><span class="am-icon-sign-out"></span> 自定义查询设置</a></li>
      </ul>

      <div class="am-panel am-panel-default admin-sidebar-panel">
        <div class="am-panel-bd">
          <p><span class="am-icon-bookmark"></span> 公告</p>
          <p>时光静好，与君语；细水流年，与君同。—— Amaze UI</p>
        </div>
      </div>

      <div class="am-panel am-panel-default admin-sidebar-panel">
        <div class="am-panel-bd">
          <p><span class="am-icon-tag"></span> wiki</p>
          <p>Welcome to Table</p>
        </div>
      </div>
    </div>
  </div>
  <!-- sidebar end -->

  <!-- content start -->
  <div class="admin-content">

    <div class="am-cf am-padding">
      <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">首页</strong> / <small>Table</small></div>
    </div>

    <div class="am-g">
      <div class="am-u-sm-12 am-u-md-6">
        <div class="am-btn-toolbar">
          <div class="am-btn-group am-btn-group-xs">
            <button onclick="add()" type="button" class="am-btn am-btn-default"><span class="am-icon-plus"></span> 新增</button>
            <button onclick="save()" type="button" class="am-btn am-btn-default"><span class="am-icon-save"></span> 保存</button>
            <button type="button" class="am-btn am-btn-default"><span class="am-icon-trash-o"></span> 删除</button>
          </div>
        </div>
      </div>
    </div>

    <div class="am-g">
      <div class="am-u-sm-12">
          <table id="rowed5" class="am-table am-table-striped am-table-hover table-main">
        </table>
         <div id="Pager"></div>
	  </div>
	</div>
  </div>
 </div>
<a href="#" class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu" data-am-offcanvas="{target: '#admin-offcanvas'}"></a>

<div class="am-modal am-modal-prompt" tabindex="-1" id="my-prompt">
  <div class="am-modal-dialog">
  <div class="am-modal-hd">给这张表起个名字吧</div>
   <form class="am-form am-form-horizontal">
  <div class="am-form-group">
    <label for="doc-ipt-3" class="am-u-sm-2 am-form-label">表名称</label>
    <div class="am-u-sm-10">
      <input type="text" id="doc-ipt-3" placeholder="输入表名称,比如user">
    </div>
  </div>
  <div class="am-form-group">
    <label for="doc-ipt-2" class="am-u-sm-2 am-form-label">表描述</label>
    <div class="am-u-sm-10">
      <input type="text" id="doc-ipt-2" placeholder="设置一个表描述,比如用户表">
    </div>
  </div>
  </form>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>保存</span>
    </div>
  </div>
</div>
<footer>
  <hr>
  <p class="am-padding-left">© 2014 AllMobilize, Inc. Licensed under MIT license.</p>
</footer>

</body>
</html>
